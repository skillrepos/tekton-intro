apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: update-deployment
spec:
  description:
    Run sed to update manifests to latest images  
  workspaces:
    - name: source
  params:
    - name: pathToManifest
      description: The path to the manifest flie
    - name: dbImageUrl
      description: Url of db image
      default: "localhost:5000/roar-db:1.0.0"
    - name: webImageUrl
      description: Url of web image
      default: "localhost:5000/roar-web:1.0.0"
  steps:
    - name: update-manifest-for-db-image
      image: alpine
      env:
        - name: SHARED_WORKSPACE_PATH
          value: $(workspaces.source.path)
      command: ["sed"]
      args:
        - "-i"
        - "-e"
        - "s;__DBIMAGE__;$(params.dbImageUrl);g"
        - "$(workspaces.source.path)/$(params.pathToManifest)"
    - name: update-manifest-for-web-image
      image: alpine
      env:
      - name: SHARED_WORKSPACE_PATH
        value: $(workspaces.source.path)
      command: ["sed"]
      args:
        - "-i"
        - "-e"
        - "s;__WEBIMAGE__;$(params.webImageUrl);g"
        - "$(workspaces.source.path)/$(params.pathToManifest)"
---
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: deploy-to-cluster
spec:
  description:
    Run kubectl to deploy manifest to cluster
  workspaces:
    - name: source
  params:
    - name: pathToManifest
      description: The path to the manifest file
  steps:
    - name: run-kubectl
      image: lachlanevenson/k8s-kubectl
      env:
        - name: SHARED_WORKSPACE_PATH
          value: $(workspaces.source.path)
      command: ["kubectl"]
      args: 
        - "apply"
        - "-f"
        - "$(workspaces.source.path)/$(params.pathToManifest)"
                                      
